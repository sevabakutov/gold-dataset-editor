<div class="entry-card {% if has_unsaved %}unsaved{% endif %}" data-entry-index="{{ index }}">
    <!-- Entry ID -->
    <div class="entry-id">
        <span class="label">ID:</span>
        <span class="value">{{ entry.id }}</span>
        {% if has_unsaved %}
        <span class="unsaved-badge">Unsaved</span>
        {% endif %}
    </div>

    <!-- Message -->
    <div class="message-section">
        <h3>Message</h3>
        <div class="message-box {% if entry.message.role == 'client' %}client{% else %}brand{% endif %}">
            <select class="role-select" onchange="updateMessageRole(this.value)">
                <option value="client" {% if entry.message.role == 'client' %}selected{% endif %}>client</option>
                <option value="brand" {% if entry.message.role == 'brand' %}selected{% endif %}>brand</option>
            </select>
            <p class="text">{{ entry.message.text if entry.message.text else entry.message }}</p>
        </div>
    </div>

    <!-- Context -->
    {% if entry.context %}
    <div class="context-section">
        <h3>Context <span class="count">({{ entry.context|length }})</span></h3>
        <div class="context-messages">
            {% for msg in entry.context %}
            <div class="context-msg {% if msg.role == 'client' %}client{% else %}brand{% endif %}">
                <select class="role-select" onchange="updateContextRole({{ loop.index0 }}, this.value)">
                    <option value="client" {% if msg.role == 'client' %}selected{% endif %}>client</option>
                    <option value="brand" {% if msg.role == 'brand' %}selected{% endif %}>brand</option>
                </select>
                <span class="text">{{ msg.text }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Intentions (moved before Slots) -->
    <div class="intentions-section">
        <h3>Intentions</h3>
        <div class="intentions-grid">
            {% for intention in intention_types %}
            <label class="intention-checkbox">
                <input type="checkbox"
                       name="intention-{{ intention }}"
                       value="{{ intention }}"
                       {% if entry.gold.intentions and intention in entry.gold.intentions %}checked{% endif %}
                       onchange="toggleIntention('{{ intention }}', this.checked)">
                <span class="intention-label">{{ intention }}</span>
            </label>
            {% endfor %}
        </div>
    </div>

    <!-- Slots Form -->
    <div class="slots-section">
        <h3>Slots</h3>
        <form id="slots-form" class="slots-form">
            <!-- Multi-Select Slots -->
            {% for slot in string_slots %}
            {% if slot in multi_select_slots %}
            <div class="slot-row multi-select-slot" data-slot="{{ slot }}">
                <label for="slot-{{ slot }}">{{ slot }}</label>
                <div class="multi-select-container">
                    <div class="multi-select-display" onclick="toggleMultiSelectDropdown('{{ slot }}')">
                        <div class="selected-tags" id="tags-{{ slot }}">
                            {% set slot_val = entry.gold.slots[slot] %}
                            {% if slot_val is none %}
                            <span class="placeholder">null</span>
                            {% elif slot_val is string %}
                            <span class="selected-tag" data-value="{{ slot_val }}">
                                {{ slot_val }}
                                <button type="button" class="tag-remove" onclick="event.stopPropagation(); removeSlotValue('{{ slot }}', '{{ slot_val }}')">&times;</button>
                            </span>
                            {% elif slot_val is iterable %}
                            {% for val in slot_val %}
                            <span class="selected-tag" data-value="{{ val }}">
                                {{ val }}
                                <button type="button" class="tag-remove" onclick="event.stopPropagation(); removeSlotValue('{{ slot }}', '{{ val }}')">&times;</button>
                            </span>
                            {% endfor %}
                            {% if not slot_val %}
                            <span class="placeholder">null</span>
                            {% endif %}
                            {% endif %}
                        </div>
                        <button type="button" class="dropdown-toggle" title="Toggle dropdown">&#9662;</button>
                    </div>
                    <div class="multi-select-dropdown" id="dropdown-{{ slot }}">
                        <div class="dropdown-search">
                            <input type="text"
                                   class="dropdown-search-input"
                                   placeholder="Type to add or search..."
                                   onkeydown="handleDropdownKeydown(event, '{{ slot }}')"
                                   oninput="filterDropdownOptions('{{ slot }}', this.value)">
                        </div>
                        <div class="dropdown-options" id="options-{{ slot }}">
                            {% for option in slot_options[slot] %}
                            {% set slot_val = entry.gold.slots[slot] %}
                            {% set is_selected = (slot_val == option) or (slot_val is iterable and slot_val is not string and option in slot_val) %}
                            <label class="dropdown-option">
                                <input type="checkbox"
                                       value="{{ option }}"
                                       {% if is_selected %}checked{% endif %}
                                       onchange="toggleSlotOption('{{ slot }}', '{{ option }}', this.checked)">
                                <span>{{ option }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <button type="button" class="clear-btn" onclick="clearSlot('{{ slot }}')" title="Set to null">
                    &times;
                </button>
            </div>
            {% else %}
            <!-- Regular Text Input Slots (number_phone, name, date_time, specialist_name) -->
            <div class="slot-row string-slot" data-slot="{{ slot }}">
                <label for="slot-{{ slot }}">{{ slot }}</label>
                <div class="slot-input-group">
                    <input type="text"
                           id="slot-{{ slot }}"
                           name="{{ slot }}"
                           value="{{ entry.gold.slots[slot] | slot_value }}"
                           placeholder="null"
                           class="slot-input {% if slot == 'number_phone' %}validate-phone{% endif %}"
                           onchange="updateSlot('{{ slot }}', this.value)"
                           onfocus="setActiveSlot('{{ slot }}')">
                    <button type="button" class="clear-btn" onclick="clearSlot('{{ slot }}')" title="Set to null">
                        &times;
                    </button>
                </div>
                <div class="validation-warning" id="warning-{{ slot }}"></div>
            </div>
            {% endif %}
            {% endfor %}

            <!-- Boolean Slots (Tri-state) -->
            {% for slot in bool_slots %}
            {% set slot_val = entry.gold.slots.get(slot) %}
            <div class="slot-row bool-slot" data-slot="{{ slot }}">
                <label>{{ slot }}</label>
                <div class="tristate" data-slot="{{ slot }}" data-value="{{ slot_val | tojson }}" onfocus="setActiveSlot('{{ slot }}')" tabindex="0">
                    <button type="button"
                            class="ts-btn ts-true {% if slot_val == true %}active{% endif %}"
                            onclick="setBoolSlot('{{ slot }}', true)"
                            title="True (1)">T</button>
                    <button type="button"
                            class="ts-btn ts-false {% if slot_val == false %}active{% endif %}"
                            onclick="setBoolSlot('{{ slot }}', false)"
                            title="False (2)">F</button>
                    <button type="button"
                            class="ts-btn ts-null {% if slot_val is none %}active{% endif %}"
                            onclick="setBoolSlot('{{ slot }}', null)"
                            title="Null (3)">N</button>
                </div>
            </div>
            {% endfor %}
        </form>
    </div>

    <!-- Actions -->
    <div class="entry-actions">
        <button class="btn {% if entry.reviewed %}btn-success{% else %}btn-secondary{% endif %}"
                id="reviewed-btn"
                onclick="toggleReviewed()"
                title="Toggle reviewed (r)">
            {% if entry.reviewed %}Reviewed{% else %}Mark as Reviewed{% endif %}
        </button>
    </div>
</div>

<script>
    // Update progress indicator
    document.getElementById('current-index').textContent = {{ index + 1 }};
    window.currentEntryIndex = {{ index }};

    // Sync reviewed status to sidebar
    const fileItem = document.querySelector(`.file-item[data-file-id="${window.currentFileId}"]`);
    if (fileItem) {
        {% if entry.reviewed %}
        fileItem.classList.add('reviewed');
        {% else %}
        fileItem.classList.remove('reviewed');
        {% endif %}
    }

    // Initialize validation
    if (typeof initValidation === 'function') {
        initValidation();
    }
</script>
